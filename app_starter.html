<!-- https://estherformula.github.io/static-web/app_starter.html?deeplink=estherpack://store -->

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>앱으로 이동</title>

    <!-- Open Graph 메타 태그 (카톡, 페이스북 등 공유시 표시) -->
    <meta property="og:title" content="앱 이름">
    <meta property="og:description" content="앱에서 확인하세요!">
    <meta property="og:image" content="https://your-domain.com/app-icon.png">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .container {
            text-align: center;
            padding: 20px;
            max-width: 400px;
        }

        .loading {
            font-size: 24px;
            margin-bottom: 20px;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .manual-links {
            margin-top: 30px;
            opacity: 0;
            animation: fadeIn 1s forwards;
            animation-delay: 2s;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .store-button {
            display: inline-block;
            margin: 10px;
            padding: 12px 24px;
            background: white;
            color: #667eea;
            text-decoration: none;
            border-radius: 25px;
            font-weight: bold;
            transition: transform 0.2s;
            cursor: pointer;
            border: none;
            font-size: 16px;
        }

        .store-button:hover {
            transform: scale(1.05);
        }

        .debug-info {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 14px;
            text-align: left;
            font-family: 'Courier New', monospace;
        }

        .test-notice {
            background: rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .status {
            font-size: 14px;
            margin-top: 10px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="loading">앱으로 이동 중...</div>
    <div class="spinner"></div>
    <div class="status" id="status">앱 실행을 시도하고 있습니다...</div>

    <!-- 테스트 안내 메시지 -->
<!--    <div class="test-notice">-->
<!--        <p>⚠️ 현재 자동 실행이 비활성화되어 있습니다</p>-->
<!--        <p style="font-size: 14px;">실제 사용시 138번째 줄 주석을 해제하세요</p>-->
<!--    </div>-->

    <!-- 수동 링크 -->
    <div class="manual-links">
        <p>수동 테스트:</p>
        <button onclick="executeDeepLink()" class="store-button" style="background: #4CAF50; color: white;">
            🚀 앱 실행하기
        </button>
        <br><br>
        <p>또는 스토어로 직접 이동:</p>
        <a href="#" onclick="goToStore(); return false;" class="store-button" id="store-link">
            🏪 앱 스토어로 이동
        </a>
    </div>

    <!-- 디버그 정보 -->
    <div class="debug-info" id="debug-info"></div>
</div>

<script>
    // ⚠️ 아래 설정을 실제 앱 정보로 변경하세요!
    const CONFIG = {
        // 딥링크 설정
        deepLink: 'estherpack://',  // 앱 Custom Scheme URL

        // 앱 스토어 URL
        appStores: {
            ios: 'https://apps.apple.com/app/id6737678222',  // iOS 앱 스토어 URL
            android: 'https://play.google.com/store/apps/details?id=com.estherformula.estherpack.android',  // 안드로이드 플레이스토어 URL
            fallback: 'https://esthermall.co.kr'  // 둘 다 아닐 경우 (데스크톱 등) 이동할 URL
        },

        // 타이밍 설정 (밀리초)
        waitTime: 2500,  // 앱 실행 대기 시간 (2.5초)
        delayBeforeExecute: 100  // 페이지 로드 후 실행 대기 시간
    };

    // ==========================================
    // 🔴 자동 실행 코드 - 실제 사용시 아래 주석을 해제하세요!
    // ==========================================

    setTimeout(executeDeepLink, CONFIG.delayBeforeExecute);  // 👈 이 줄의 주석(//)을 제거하면 자동 실행됩니다

    // ==========================================
    // 🔴 자동 실행 코드 끝
    // ==========================================

    // OS 감지
    function detectOS() {
        const userAgent = navigator.userAgent || navigator.vendor || window.opera;

        if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
            return 'ios';
        }

        if (/android/i.test(userAgent)) {
            return 'android';
        }

        return 'other';
    }

    // 앱 스토어로 이동
    function goToStore() {
        const os = detectOS();
        let storeUrl;

        switch(os) {
            case 'ios':
                storeUrl = CONFIG.appStores.ios;
                break;
            case 'android':
                storeUrl = CONFIG.appStores.android;
                break;
            default:
                storeUrl = CONFIG.appStores.fallback;
        }

        updateStatus('앱 스토어로 이동합니다...');
        window.location.href = storeUrl;
    }

    // 딥링크 실행 (앱 실행 시도)
    function executeDeepLink() {
        const startTime = Date.now();

        updateStatus('앱 실행을 시도합니다...');

        // 딥링크 실행 시도
        // iframe 방식 (iOS/Android 모두 지원)
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = CONFIG.deepLink;
        document.body.appendChild(iframe);

        // 대체 방법: location.href (일부 환경에서 더 잘 작동)
        setTimeout(() => {
            window.location.href = CONFIG.deepLink;
        }, 100);

        // 앱이 실행되지 않았는지 확인
        let appOpened = false;
        const checkInterval = setInterval(() => {
            if (document.hidden || document.webkitHidden) {
                // 페이지가 백그라운드로 갔다면 앱이 실행된 것
                appOpened = true;
                clearInterval(checkInterval);
                clearTimeout(fallbackTimeout);
                updateStatus('앱이 실행되었습니다!');
            }
        }, 200);

        // 일정 시간 후에도 앱이 열리지 않으면 스토어로 이동
        const fallbackTimeout = setTimeout(() => {
            clearInterval(checkInterval);
            if (!appOpened && !document.hidden) {
                updateStatus('앱이 설치되지 않았습니다. 스토어로 이동합니다...');
                setTimeout(goToStore, 500);
            }
        }, CONFIG.waitTime);

        // 페이지 포커스 이벤트 감지 (더 정확한 감지)
        window.addEventListener('blur', () => {
            appOpened = true;
            clearInterval(checkInterval);
            clearTimeout(fallbackTimeout);
        });

        // iOS Safari의 경우 추가 감지
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                appOpened = true;
                clearInterval(checkInterval);
                clearTimeout(fallbackTimeout);
            }
        });
    }

    // 상태 메시지 업데이트
    function updateStatus(message) {
        const statusEl = document.getElementById('status');
        if (statusEl) {
            statusEl.textContent = message;
        }
        console.log(message);
    }

    // URL 파라미터 처리 (동적 딥링크용)
    function processUrlParams() {
        const params = new URLSearchParams(window.location.search);

        const couponCode = params.get('coupon');
        if (couponCode) {
            CONFIG.deepLink = `estherpack://my/myCoupon?couponCode=${couponCode}`;
            console.log(`deeplink = coupon, code = ${couponCode}`)
            return
        }

        // 예: ?goodsId=5678 -> myapp://goods/5678
        const goodsId = urlParams.get('goodsId');
        if (goodsId) {
            CONFIG.deepLink = `estherpack://store/goods?goodsId=${goodsId}`;
            console.log(`deeplink = goods, code = ${goodsId}`)
            return
        }

        // 캠페인 파라미터 처리
        const campaign = urlParams.get('campaign');
        if (campaign) {
            // 딥링크에 캠페인 정보 추가
            CONFIG.deepLink += `?campaign=${campaign}`;
            console.log(`deeplink = campaign, code = ${campaign}`)
            return
        }
        console.log(`deeplink = null`)
    }

    // 디버그 정보 표시
    function showDebugInfo() {
        const debugEl = document.getElementById('debug-info');
        const os = detectOS();

        debugEl.innerHTML = `
                <strong>🔍 디버그 정보:</strong><br>
                <strong>OS:</strong> ${os}<br>
                <strong>User Agent:</strong> ${navigator.userAgent.substring(0, 80)}...<br>
                <strong>딥링크:</strong> ${CONFIG.deepLink}<br>
                <strong>iOS 스토어:</strong> ${CONFIG.appStores.ios}<br>
                <strong>Android 스토어:</strong> ${CONFIG.appStores.android}<br>
                <strong>대기 시간:</strong> ${CONFIG.waitTime}ms
            `;
    }

    // 초기화
    window.addEventListener('DOMContentLoaded', () => {
        processUrlParams();
        showDebugInfo();
    });
</script>
</body>
</html>
